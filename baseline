#!/usr/bin/env python3
import argparse
import sys
import os
import subprocess
from pathlib import Path

def run_command(cmd, env=None):
    print(f"Running: {' '.join(cmd)}")
    result = subprocess.run(cmd, capture_output=False, env=env)
    if result.returncode != 0:
        print(f"Command failed with exit code {result.returncode}")
        sys.exit(result.returncode)

def main():
    parser = argparse.ArgumentParser(description="Baseline Factory CLI")
    subparsers = parser.add_subparsers(dest="command", help="Subcommand to run")

    # Ingest
    ingest_parser = subparsers.add_parser("ingest", help="Ingest raw data files")
    ingest_parser.add_argument("--input", "-i", help="Input directory", default="data_files/Language Services")

    # Extract
    extract_parser = subparsers.add_parser("extract", help="Extract and standardize data")

    # Validate
    validate_parser = subparsers.add_parser("validate", help="Validate data")

    # Report
    report_parser = subparsers.add_parser("report", help="Generate report artifacts")

    # Run (All)
    run_parser = subparsers.add_parser("run", help="Run full pipeline")
    run_parser.add_argument("--input", "-i", help="Input directory", default="data_files/Language Services")
    run_parser.add_argument("--client", "-c", help="Client name", default="default")

    args = parser.parse_args()

    if args.command == "run":
        # For now, run the existing pipeline
        # We'll enhance run_pipeline.py later to respect these args
        env = os.environ.copy()
        env["CLIENT_NAME"] = args.client
        env["INPUT_DIR"] = args.input
        run_command([sys.executable, "multi_agent_system/run_pipeline.py"], env=env)
    elif args.command in ["ingest", "extract", "validate", "report"]:
        print(f"Subcommand '{args.command}' is partially implemented via 'run'.")
        print("Running full pipeline for now.")
        env = os.environ.copy()
        run_command([sys.executable, "multi_agent_system/run_pipeline.py"], env=env)
    else:
        parser.print_help()

if __name__ == "__main__":
    main()
